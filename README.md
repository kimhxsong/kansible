# Kansible - Kubernetes í´ëŸ¬ìŠ¤í„° ìë™ êµ¬ì„±

Vagrantì™€ Ansibleì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ì¤‘ ë…¸ë“œ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ìë™ìœ¼ë¡œ êµ¬ì„±í•˜ëŠ” í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.

## ì‹¤í–‰ í™˜ê²½ ë° ìš”êµ¬ì‚¬í•­

### ì†Œí”„íŠ¸ì›¨ì–´ ìš”êµ¬ì‚¬í•­
- **VirtualBox 7.1+** (ARM64 ì§€ì›)
- **Vagrant 2.3+**
- **Ansible 2.9+**
- **ê¸°íƒ€**: `git`, `curl`

> **Note**: AMD64/Intel (x86_64) ì•„í‚¤í…ì²˜ ì‚¬ìš©ì ì•ˆë‚´
> 
> ì´ í”„ë¡œì íŠ¸ëŠ” Apple Silicon (ARM64) í™˜ê²½ì—ì„œ ê¸°ë³¸ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë§Œì•½ AMD64/Intel ê¸°ë°˜ì˜ í˜¸ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì‹ ë‹¤ë©´, `Vagrantfile`ì˜ `config.vm.box` ì„¤ì •ì„ ìì‹ ì˜ í™˜ê²½ì— ë§ëŠ” Boxë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
> 
> ```ruby
> # Vagrantfile
> config.vm.box = "net9/ubuntu-24.04-arm64" # ì´ ë¶€ë¶„ì„ amd64ìš© Boxë¡œ ë³€ê²½
> ```
> 
> í˜¸í™˜ë˜ëŠ” BoxëŠ” [Vagrant Cloud](https://portal.cloud.hashicorp.com/vagrant/discover)ì—ì„œ `ubuntu` ë“±ìœ¼ë¡œ ê²€ìƒ‰í•˜ì—¬ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì˜ˆ: `ubuntu/noble64`)
> 
> Ansible í”Œë ˆì´ë¶ì€ ì•„í‚¤í…ì²˜ë¥¼ ìë™ìœ¼ë¡œ ê°ì§€í•˜ë¯€ë¡œ ë³„ë„ì˜ ìˆ˜ì •ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.

### í•˜ë“œì›¨ì–´ ìš”êµ¬ì‚¬í•­
- **RAM**: ìµœì†Œ 12GB (í˜¸ìŠ¤íŠ¸ 4GB + í´ëŸ¬ìŠ¤í„° 8GB)
- **ë””ìŠ¤í¬**: ìµœì†Œ 20GB ì—¬ìœ  ê³µê°„
- **CPU**: 4ì½”ì–´ ì´ìƒ ê¶Œì¥

## ì„¤ì¹˜ ë° ì„¤ì •

1. **ì €ì¥ì†Œ í´ë¡ :**
   ```sh
   git clone https://github.com/kimhxsong/kansible
   cd kansible
   ```

2. **Ubuntu ISO ë‹¤ìš´ë¡œë“œ (í•„ìš” ì‹œ):**
   `Vagrantfile`ì—ì„œ `config.vm.box`ê°€ ì„¤ì •ëœ ê²½ìš° ì´ ë‹¨ê³„ëŠ” í•„ìš” ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ ISO íŒŒì¼ì„ ì§ì ‘ ì‚¬ìš©í•˜ë ¤ë©´ ì•„ë˜ ëª…ë ¹ì–´ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.
   ```sh
   make download-iso
   ```
   ë‹¤ìš´ë¡œë“œëœ `ubuntu-24.04.2-live-server-arm64.iso` íŒŒì¼ì€ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

ëª¨ë“  ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆë‹¤ë©´, ë‹¤ìŒ ëª…ë ¹ì–´ í•˜ë‚˜ë¡œ ì „ì²´ í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í•˜ê³  êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
# VM ìƒì„±ë¶€í„° Kubernetes í´ëŸ¬ìŠ¤í„° êµ¬ì„±ê¹Œì§€ í•œ ë²ˆì— ì‹¤í–‰
make all
```

í”„ë¡œì„¸ìŠ¤ê°€ ì™„ë£Œë˜ë©´, `make validate` ëª…ë ¹ì–´ë¡œ í´ëŸ¬ìŠ¤í„° ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ğŸ“š ìƒì„¸ ì‚¬ìš©ë²•

### ë°©ë²• 1: Makefile ì‚¬ìš© (ê¶Œì¥)

ì´ í”„ë¡œì íŠ¸ëŠ” ëª¨ë“  ì¼ë°˜ì ì¸ ì‘ì—…ì„ ê°„ì†Œí™”í•˜ê¸° ìœ„í•´ `Makefile`ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

#### ì£¼ìš” ëª…ë ¹ì–´
- **í´ëŸ¬ìŠ¤í„° ì „ì²´ ìƒì„±:**
  ```sh
  make all
  ```
- **VMë§Œ ì‹œì‘:**
  ```sh
  make up
  ```
- **ì‹¤í–‰ ì¤‘ì¸ VMì— Kubernetes êµ¬ì„±:**
  ```sh
  make cluster
  ```
- **í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸:**
  ```sh
  make validate
  ```
- **í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™”:**
  ```sh
  make reset
  ```
- **ëª¨ë“  VM ì‚­ì œ ë° í™˜ê²½ ì •ë¦¬:**
  ```sh
  make destroy
  ```

#### SSH ì ‘ì† ë° ê¸°íƒ€ ëª…ë ¹ì–´
- **ë§ˆìŠ¤í„° ë…¸ë“œ ì ‘ì†:** `make ssh-master`
- **ì›Œì»¤ ë…¸ë“œ ì ‘ì†:** `make ssh-worker1`, `make ssh-worker2`, ...
- **Kubelet ë¡œê·¸ í™•ì¸:** `make logs`
- **í…ŒìŠ¤íŠ¸ ì•± ë°°í¬:** `make deploy-test`

### ë°©ë²• 2: ìˆ˜ë™ ì‹¤í–‰

`Makefile`ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ê° ë‹¨ê³„ë¥¼ ì§ì ‘ ì‹¤í–‰í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

1. **VM ìƒì„± ë° ì‹œì‘:**
   ```bash
   vagrant up
   ```

2. **Ansible í”Œë ˆì´ë¶ ì‹¤í–‰:**
   ```bash
   ansible-playbook -i ansible/inventory.ini ansible/configure-cluster.yml
   ```

3. **í´ëŸ¬ìŠ¤í„° ìƒíƒœ ê²€ì¦:**
   ```bash
   vagrant ssh k8s-master -c "kubectl get nodes -o wide"
   vagrant ssh k8s-master -c "kubectl get pods -n kube-system"
   ```

### ì¼ë°˜ì ì¸ ì›Œí¬í”Œë¡œìš° ì‹œë‚˜ë¦¬ì˜¤

- **ìµœì´ˆ í™˜ê²½ êµ¬ì„±:**
  `make all`

- **ì¤‘ë‹¨í–ˆë˜ í™˜ê²½ ë‹¤ì‹œ ì‹œì‘:**
  `make up` ì‹¤í–‰ í›„ `make validate`ë¡œ ìƒíƒœ í™•ì¸

- **í´ëŸ¬ìŠ¤í„° ì¬êµ¬ì„±:**
  `make reset` -> `make cluster` -> `make validate`

- **ê°œë°œ ì™„ë£Œ í›„ ì •ë¦¬:**
  - ì¼ì‹œ ì •ì§€: `make down`
  - ì™„ì „ ì‚­ì œ: `make destroy`

## ğŸ› ë¬¸ì œ í•´ê²°

### VM ë¶€íŒ… ë˜ëŠ” SSH ì—°ê²° ì‹¤íŒ¨
- **í•´ê²°ì±… 1: VM ì¬ì‹œì‘**
  ```bash
  make down && make up
  ```
- **í•´ê²°ì±… 2: ìˆ˜ë™ SSH ì—°ê²° í…ŒìŠ¤íŠ¸**
  ```bash
  vagrant ssh k8s-master
  ```
  ì´ë•Œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤.

### í´ëŸ¬ìŠ¤í„° êµ¬ì„± ì‹¤íŒ¨
- **í•´ê²°ì±… 1: í´ëŸ¬ìŠ¤í„° ì™„ì „ ì´ˆê¸°í™” í›„ ì¬êµ¬ì„±**
  ```bash
  make reset
  make cluster
  ```
- **í•´ê²°ì±… 2: Kubelet ë¡œê·¸ í™•ì¸**
  ë§ˆìŠ¤í„° ë…¸ë“œì— ì ‘ì†í•˜ì—¬ `sudo journalctl -u kubelet -f` ëª…ë ¹ì–´ë¡œ ì‹¤ì‹œê°„ ë¡œê·¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
  ```bash
  make logs
  ```

### ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¬¸ì œ
- **ë…¸ë“œ ê°„ Ping í…ŒìŠ¤íŠ¸:**
  ```bash
  vagrant ssh k8s-master -c "ping 192.168.127.129"
  ```
- **ë¼ìš°íŒ… í…Œì´ë¸” í™•ì¸:**
  ```bash
  vagrant ssh k8s-master -c "ip route"
  ```

## âš™ï¸ ê¸°ìˆ  ì‚¬ì–‘

### ê°œë°œ í™˜ê²½
- **í˜¸ìŠ¤íŠ¸ OS**: macOS 15.5 (24F74) - Apple Silicon (ARM64)
- **VirtualBox**: 7.1.8r168469
- **ê²ŒìŠ¤íŠ¸ OS**: Ubuntu 24.04.2 LTS Server (ARM64)
- **VM Box**: net9/ubuntu-24.04-arm64 v1.1
- **ISO**: ubuntu-24.04.2-live-server-arm64.iso

### ì†Œí”„íŠ¸ì›¨ì–´ ë²„ì „
- **Kubernetes**: v1.33.2 (2024ë…„ 12ì›” ê¸°ì¤€ ìµœì‹  ì•ˆì • ë²„ì „)
  - Ansible í”Œë ˆì´ë¶ì´ `https://dl.k8s.io/release/stable.txt`ì—ì„œ ìµœì‹  ì•ˆì • ë²„ì „ì„ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜´
  - kubelet, kubeadm, kubectl ëª¨ë‘ ë™ì¼í•œ ë²„ì „ìœ¼ë¡œ ì„¤ì¹˜
- **Container Runtime**: containerd (Ubuntu íŒ¨í‚¤ì§€ ì €ì¥ì†Œ)
- **CNI**: Flannel (ìµœì‹  ë¦´ë¦¬ì¦ˆ ë²„ì „)
- **Ansible**: 2.9+ (í˜¸ìŠ¤íŠ¸ì— ì„¤ì¹˜)

### í´ëŸ¬ìŠ¤í„° ì•„í‚¤í…ì²˜
![](./image.png)


### ë„¤íŠ¸ì›Œí¬ êµ¬ì„±
- **í˜¸ìŠ¤íŠ¸ ì „ìš© ë„¤íŠ¸ì›Œí¬**: 192.168.127.0/24
- **Pod CIDR**: 10.244.0.0/16 (Flannel CNI)
- **ì„œë¹„ìŠ¤ CIDR**: 10.96.0.0/12

### Ansible í”Œë ˆì´ë¶ êµ¬ì¡°
- **`configure-network.yml`**: ë„¤íŠ¸ì›Œí¬ ì„¤ì •
- **`configure-cluster.yml`**: í´ëŸ¬ìŠ¤í„° ì „ì²´ êµ¬ì„± (ê³µí†µ ì„¤ì •, ë§ˆìŠ¤í„° ì´ˆê¸°í™”, ì›Œì»¤ ì¡°ì¸)
- **`reset-cluster.yml`**: í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™”


## ğŸ“– ì°¸ê³  ìë£Œ

- [Kubernetes ê³µì‹ ë¬¸ì„œ](https://kubernetes.io/docs/)
- [Vagrant ê³µì‹ ë¬¸ì„œ](https://www.vagrantup.com/docs)
- [Ansible ê³µì‹ ë¬¸ì„œ](https://docs.ansible.com/)

